@page "/setup"
@inject JournalApp.Services.LockService LockService
@inject JournalApp.Services.AppState AppState
@inject NavigationManager Nav

<h3>Set up your Journal Lock</h3>

@if (!string.IsNullOrEmpty(Message))
{
    <div class="alert alert-danger" style="max-width:450px">@Message</div>
}

<div style="max-width:450px">
    <label>Username</label>
    <input class="form-control" @bind="Username" />

    <br />

    <label>PIN / Password</label>
    <input class="form-control" type="password" @bind="Pin" />

    <br />

    <label>Confirm PIN / Password</label>
    <input class="form-control" type="password" @bind="ConfirmPin" />

    <br />
    <hr />

    <h5>Security Questions (for reset)</h5>

    <label>Security Question 1</label>
    <input class="form-control" value="@SecurityQuestion1" disabled />

    <br />

    <label>Answer 1</label>
    <input class="form-control" @bind="SecurityAnswer1" />

    <br />

    <label>Security Question 2</label>
    <input class="form-control" value="@SecurityQuestion2" disabled />

    <br />

    <label>Answer 2</label>
    <input class="form-control" @bind="SecurityAnswer2" />

    <br />

    <button class="btn btn-primary" @onclick="Save">
        Save & Continue
    </button>
</div>

@code {
    private string Username = "";
    private string Pin = "";
    private string ConfirmPin = "";
    private string? Message;

    // Fixed questions reduce setup errors and make verification consistent
    private string SecurityQuestion1 = "What is your favourite food?";
    private string SecurityAnswer1 = "";

    private string SecurityQuestion2 = "What is the name of your first school?";
    private string SecurityAnswer2 = "";

    protected override async Task OnInitializedAsync()
    {
        // If already configured, setup should not be shown again
        if (await LockService.HasPinAsync())
        {
            Nav.NavigateTo("/unlock", true);
        }
    }

    private async Task Save()
    {
        Message = null;

        if (string.IsNullOrWhiteSpace(Username))
        {
            Message = "Username is required.";
            return;
        }

        if (string.IsNullOrWhiteSpace(Pin) || Pin.Length < 4)
        {
            Message = "PIN must be at least 4 characters.";
            return;
        }

        if (Pin != ConfirmPin)
        {
            Message = "PIN and Confirm PIN do not match.";
            return;
        }

        if (string.IsNullOrWhiteSpace(SecurityAnswer1) || string.IsNullOrWhiteSpace(SecurityAnswer2))
        {
            Message = "Please fill both security answers.";
            return;
        }

        LockService.SaveUsername(Username.Trim());
        await LockService.SavePinAsync(Pin);

        await LockService.SaveSecurityQuestionsAsync(
            SecurityQuestion1,
            SecurityAnswer1,
            SecurityQuestion2,
            SecurityAnswer2
        );

        // Mark session as unlocked after setup
        AppState.SetUnlocked(Username.Trim());

        Nav.NavigateTo("/editor", true);
    }
}
