@page "/my-journals"
@using JournalApp.Models
@inject JournalApp.Services.JournalService JournalService
@inject NavigationManager Nav

<h3>My Journal Entries</h3>

@if (entries is null)
{
    <p>Loading...</p>
}
else if (totalCount == 0)
{
    <p>No journal entries saved yet.</p>
}
else
{
    <div style="max-width:900px; margin-bottom:12px; display:flex; justify-content:space-between; align-items:center;">
        <div>
            Page @currentPage of @totalPages
        </div>

        <div>
            <button class="btn btn-secondary btn-sm" @onclick="PrevPage" disabled="@(!CanPrev)">
                Previous
            </button>

            <button class="btn btn-secondary btn-sm" style="margin-left:8px" @onclick="NextPage" disabled="@(!CanNext)">
                Next
            </button>

            <select class="form-control" style="width:110px; display:inline-block; margin-left:12px;"
                    @bind="pageSize" @bind:after="OnPageSizeChanged">
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="15">15</option>
            </select>
        </div>
    </div>

    <table class="table journal-table" style="max-width:900px">
        <thead>
            <tr>
                <th>Date</th>
                <th>Title</th>
                <th>Primary Mood</th>
                <th>Tags</th>
                <th style="width:160px">Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var e in entries)
            {
                <tr>
                    <td>@e.EntryDate.ToString("yyyy-MM-dd")</td>
                    <td>@e.Title</td>
                    <td>@e.PrimaryMood</td>
                    <td>@e.Tags</td>
                    <td>
                        <button class="btn btn-primary btn-sm" @onclick="() => EditEntry(e.EntryDate)">
                            Edit
                        </button>

                        <button class="btn btn-danger btn-sm" style="margin-left:8px"
                                @onclick="() => DeleteEntry(e.EntryDate)">
                            Del
                        </button>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<JournalEntry>? entries;

    private int totalCount = 0;
    private int currentPage = 1;
    private int pageSize = 5;
    private int totalPages = 1;

    private bool CanPrev => currentPage > 1;
    private bool CanNext => currentPage < totalPages;

    protected override async Task OnInitializedAsync()
    {
        await LoadPageAsync();
    }

    private async Task LoadPageAsync()
    {
        totalCount = await JournalService.GetCountAsync();
        totalPages = Math.Max(1, (int)Math.Ceiling(totalCount / (double)pageSize));

        if (currentPage > totalPages)
            currentPage = totalPages;

        entries = await JournalService.GetPageAsync(currentPage, pageSize);
    }

    private async Task NextPage()
    {
        if (!CanNext) return;
        currentPage++;
        await LoadPageAsync();
    }

    private async Task PrevPage()
    {
        if (!CanPrev) return;
        currentPage--;
        await LoadPageAsync();
    }

    private async Task OnPageSizeChanged()
    {
        currentPage = 1;
        await LoadPageAsync();
    }

    private void EditEntry(DateOnly date)
    {
        Nav.NavigateTo($"/editor/{date:yyyy-MM-dd}");
    }

    private async Task DeleteEntry(DateOnly date)
    {
        await JournalService.DeleteAsync(date);
        await LoadPageAsync();
    }
}
