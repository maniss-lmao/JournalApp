@page "/"
@page "/editor"
@page "/editor/{dateString}"
@using JournalApp.Models
@inject JournalApp.Services.JournalService JournalService
@using Markdig
@using Microsoft.AspNetCore.Components

<h3>Today's Journal Entry</h3>

@if (!string.IsNullOrEmpty(Message))
{
    <div class="alert @MessageClass" role="alert" style="max-width:600px">
        @Message
    </div>
}

<div style="max-width:600px">
    <label>Title</label><br />
    <input class="form-control" @bind="Entry.Title" />

    <br />

    <label>Content (Markdown Supported)</label><br />

    <div style="display:flex; gap:10px; margin-bottom:8px; flex-wrap:wrap">
        <button class="btn btn-secondary btn-sm" type="button" @onclick='() => InsertMd("**bold**")'>Bold</button>
        <button class="btn btn-secondary btn-sm" type="button" @onclick='() => InsertMd("_italic_")'>Italic</button>
        <button class="btn btn-secondary btn-sm" type="button" @onclick='() => InsertMd("# Heading")'>Heading</button>
        <button class="btn btn-secondary btn-sm" type="button" @onclick='() => InsertMd("- list item")'>List</button>
        <button class="btn btn-secondary btn-sm" type="button" @onclick='() => InsertMd("[text](https://example.com)")'>Link</button>

        <button class="btn btn-primary btn-sm" type="button" style="margin-left:auto" @onclick="TogglePreview">
            @(IsPreview ? "Edit" : "Preview")
        </button>
    </div>

    @if (!IsPreview)
    {
        <textarea class="form-control" rows="8" @bind="Entry.Content"></textarea>
    }
    else
    {
        <div class="form-control" style="min-height:180px; white-space:normal">
            @((MarkupString)RenderedHtml)
        </div>
    }

    <br />

    <label>Primary Mood <span style="color:red">*</span></label><br />
    <select class="form-control" @bind="Entry.PrimaryMood">
        <option value="">-- Select Primary Mood --</option>
        @foreach (var m in MoodOptions)
        {
            <option value="@m">@m</option>
        }
    </select>

    <br />

    <label>Secondary Mood 1 (optional)</label><br />
    <select class="form-control" @bind="Entry.SecondaryMood1">
        <option value="">-- None --</option>
        @foreach (var m in MoodOptions)
        {
            <option value="@m">@m</option>
        }
    </select>

    <br />

    <label>Secondary Mood 2 (optional)</label><br />
    <select class="form-control" @bind="Entry.SecondaryMood2">
        <option value="">-- None --</option>
        @foreach (var m in MoodOptions)
        {
            <option value="@m">@m</option>
        }
    </select>

    <br />

    <label>Tags</label>
    <div>
        @foreach (var tag in PredefinedTags)
        {
            <label class="tag-pill @(SelectedTags.Contains(tag) ? "tag-pill-selected" : "")">
                <input class="tag-hidden"
                       type="checkbox"
                       checked="@SelectedTags.Contains(tag)"
                       @onchange="() => ToggleTag(tag)" />
                @tag
            </label>
        }
    </div>

    <br />

    <label>Add custom tag</label>
    <input class="form-control"
           placeholder="e.g. Gym, Family"
           @bind="CustomTag" />

    <br />

    <button class="btn btn-primary" @onclick="SaveEntry">
        Save
    </button>

    <button class="btn btn-danger" style="margin-left:10px" @onclick="DeleteEntry">
        Delete
    </button>
</div>

@code {
    [Parameter] public string? dateString { get; set; }

    private JournalEntry Entry = new();
    private string? Message;
    private string MessageClass = "alert-success";

    private bool IsPreview = false;
    private string RenderedHtml = "";

    private readonly MarkdownPipeline _pipeline = new MarkdownPipelineBuilder()
        .UseAdvancedExtensions()
        .Build();

    private readonly List<string> MoodOptions = new()
    {
        "Happy", "Calm", "Grateful", "Focused",
        "Okay",
        "Sad", "Stressed", "Anxious", "Angry"
    };

    private List<string> PredefinedTags = new()
    {
        "Work", "Study", "Health", "Family", "Travel"
    };

    private HashSet<string> SelectedTags = new();
    private string CustomTag = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        DateOnly targetDate;

        if (!string.IsNullOrWhiteSpace(dateString) && DateOnly.TryParse(dateString, out var parsed))
            targetDate = parsed;
        else
            targetDate = DateOnly.FromDateTime(DateTime.Now);

        var existing = await JournalService.GetByDateAsync(targetDate);

        if (existing != null)
        {
            Entry = existing;

            if (!string.IsNullOrWhiteSpace(Entry.Tags))
            {
                SelectedTags = Entry.Tags
                    .Split(',', StringSplitOptions.RemoveEmptyEntries)
                    .Select(t => t.Trim())
                    .ToHashSet(StringComparer.OrdinalIgnoreCase);
            }
        }
        else
        {
            Entry.EntryDate = targetDate;
        }
    }

    private void TogglePreview()
    {
        IsPreview = !IsPreview;

        if (IsPreview)
        {
            RenderedHtml = Markdown.ToHtml(Entry.Content ?? "", _pipeline);
        }
    }

    private void InsertMd(string snippet)
    {
        if (string.IsNullOrWhiteSpace(Entry.Content))
            Entry.Content = snippet;
        else
            Entry.Content += "\n" + snippet;

        // If user is in preview mode, refresh preview instantly
        if (IsPreview)
        {
            RenderedHtml = Markdown.ToHtml(Entry.Content ?? "", _pipeline);
        }
    }

    private void ToggleTag(string tag)
    {
        if (!SelectedTags.Add(tag))
            SelectedTags.Remove(tag);
    }

    private async Task SaveEntry()
    {
        if (string.IsNullOrWhiteSpace(Entry.Title))
        {
            MessageClass = "alert-danger";
            Message = "Title is required.";
            return;
        }

        if (string.IsNullOrWhiteSpace(Entry.Content))
        {
            MessageClass = "alert-danger";
            Message = "Content cannot be empty.";
            return;
        }

        if (string.IsNullOrWhiteSpace(Entry.PrimaryMood))
        {
            MessageClass = "alert-danger";
            Message = "Primary mood is required.";
            return;
        }

        var p = Entry.PrimaryMood?.Trim();
        var s1 = string.IsNullOrWhiteSpace(Entry.SecondaryMood1) ? null : Entry.SecondaryMood1.Trim();
        var s2 = string.IsNullOrWhiteSpace(Entry.SecondaryMood2) ? null : Entry.SecondaryMood2.Trim();

        if (s1 != null && string.Equals(s1, p, StringComparison.OrdinalIgnoreCase))
        {
            MessageClass = "alert-danger";
            Message = "Secondary Mood 1 cannot be the same as Primary Mood.";
            return;
        }

        if (s2 != null && string.Equals(s2, p, StringComparison.OrdinalIgnoreCase))
        {
            MessageClass = "alert-danger";
            Message = "Secondary Mood 2 cannot be the same as Primary Mood.";
            return;
        }

        if (s1 != null && s2 != null && string.Equals(s1, s2, StringComparison.OrdinalIgnoreCase))
        {
            MessageClass = "alert-danger";
            Message = "Secondary Mood 1 and Secondary Mood 2 cannot be the same.";
            return;
        }

        if (!string.IsNullOrWhiteSpace(CustomTag))
        {
            SelectedTags.Add(CustomTag.Trim());
        }

        Entry.Tags = string.Join(", ", SelectedTags);

        await JournalService.SaveAsync(Entry);

        MessageClass = "alert-success";
        Message = "Journal entry saved successfully.";
        CustomTag = string.Empty;
    }

    private async Task DeleteEntry()
    {
        await JournalService.DeleteAsync(Entry.EntryDate);

        Entry = new JournalEntry
        {
            EntryDate = DateOnly.FromDateTime(DateTime.Now)
        };

        SelectedTags.Clear();
        CustomTag = string.Empty;

        MessageClass = "alert-success";
        Message = "Journal entry deleted.";
    }
}
