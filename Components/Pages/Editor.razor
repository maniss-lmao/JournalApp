@page "/"
@page "/editor"
@page "/editor/{dateString}"

@using JournalApp.Models
@using Markdig
@inject JournalApp.Services.JournalService JournalService
@inject NavigationManager Nav
@inject IJSRuntime JS

<h2 class="editor-title">Journal Entry</h2>

@if (!string.IsNullOrEmpty(Message))
{
    <div class="alert @MessageClass editor-alert" role="alert">
        @Message
    </div>
}

<div class="editor-shell">

    <!-- Top Bar -->
    <div class="editor-topbar">
        <div class="editor-top-left">
            <div class="editor-label">Title</div>
            <input class="form-control editor-title-input" @bind="Entry.Title" />
            <div class="editor-date">
                Date: @Entry.EntryDate.ToDateTime(TimeOnly.MinValue).ToString("MMMM dd, yyyy")
            </div>
        </div>

        <div class="editor-top-actions">
            <button class="btn btn-primary" @onclick="SaveEntry">Save Entry</button>
            <button class="btn btn-danger" @onclick="DeleteEntry">Delete</button>
        </div>
    </div>

    <!-- Main two-column layout -->
    <div class="editor-grid">

        <!-- LEFT: Writing area -->
        <section class="editor-left">

            <div class="editor-toolbar">
                <button type="button" class="toolbtn" title="Bold"
                        @onclick='async () => await WrapSelection("**", "**")'>
                    <span class="toolicon">B</span>
                </button>

                <button type="button" class="toolbtn" title="Italic"
                        @onclick='async () => await WrapSelection("_", "_")'>
                    <span class="toolicon"><i>I</i></span>
                </button>

                <button type="button" class="toolbtn" title="Heading"
                        @onclick='async () => await InsertLine("# ")'>
                    <span class="toolicon">H</span>
                </button>

                <button type="button" class="toolbtn" title="List"
                        @onclick='async () => await InsertLine("- ")'>
                    <span class="toolicon">•</span>
                </button>

                <button type="button" class="toolbtn" title="Link"
                        @onclick="InsertLink">
                    <span class="toolicon">🔗</span>
                </button>

                <div class="toolspacer"></div>

                <button class="btn btn-primary editor-preview-btn" type="button" @onclick="TogglePreview">
                    @(IsPreview ? "Edit" : "Preview")
                </button>
            </div>


            @if (!IsPreview)
            {
                <textarea id="@EditorTextAreaId"
                          class="form-control editor-textarea"
                          rows="18"
                          @bind="Entry.Content"></textarea>
            }
            else
            {
                <div class="editor-preview">
                    @((MarkupString)RenderedHtml)
                </div>
            }
        </section>

        <!-- RIGHT: Mood + Tags -->
        <aside class="editor-right">

            <div class="panelbox">
                <div class="paneltitle">Moods</div>

                <label class="panel-label">Primary Mood <span class="req">*</span></label>
                <select class="form-control" @bind="Entry.PrimaryMood">
                    <option value="">-- Select Primary Mood --</option>
                    @foreach (var m in MoodOptions)
                    {
                        <option value="@m">@m</option>
                    }
                </select>

                <label class="panel-label">Secondary Mood 1 (optional)</label>
                <select class="form-control" @bind="Entry.SecondaryMood1">
                    <option value="">-- None --</option>
                    @foreach (var m in MoodOptions)
                    {
                        <option value="@m">@m</option>
                    }
                </select>

                <label class="panel-label">Secondary Mood 2 (optional)</label>
                <select class="form-control" @bind="Entry.SecondaryMood2">
                    <option value="">-- None --</option>
                    @foreach (var m in MoodOptions)
                    {
                        <option value="@m">@m</option>
                    }
                </select>
            </div>

            <div class="panelbox" style="margin-top:14px">
                <div class="paneltitle">Tags</div>

                <div class="tags-wrap">
                    @foreach (var tag in PredefinedTags)
                    {
                        <button type="button"
                                class="tag-pill @(SelectedTags.Contains(tag) ? "tag-pill-selected" : "")"
                                @onclick="() => ToggleTag(tag)">
                            @tag
                        </button>
                    }
                </div>

                <label class="panel-label" style="margin-top:10px">New tag</label>
                <div class="tag-add-row">
                    <input class="form-control" placeholder="e.g. Gym" @bind="CustomTag" />
                    <button type="button" class="btn btn-secondary" @onclick="AddCustomTag">Add</button>
                </div>
            </div>

        </aside>
    </div>
</div>

@code {
    [Parameter] public string? dateString { get; set; }

    private readonly string EditorTextAreaId = "journalEditorText";

    private JournalEntry Entry = new();
    private string? Message;
    private string MessageClass = "alert-success";

    private bool IsPreview = false;
    private string RenderedHtml = "";

    private readonly List<string> MoodOptions = new()
    {
        "Happy", "Calm", "Grateful", "Focused",
        "Okay",
        "Sad", "Stressed", "Anxious", "Angry"
    };

    private List<string> PredefinedTags = new()
    {
        "Work", "Study", "Health", "Family", "Travel"
    };

    private HashSet<string> SelectedTags = new(StringComparer.OrdinalIgnoreCase);
    private string CustomTag = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        DateOnly targetDate;

        if (!string.IsNullOrWhiteSpace(dateString) && DateOnly.TryParse(dateString, out var parsed))
            targetDate = parsed;
        else
            targetDate = DateOnly.FromDateTime(DateTime.Now);

        var existing = await JournalService.GetByDateAsync(targetDate);

        if (existing != null)
        {
            Entry = existing;

            if (!string.IsNullOrWhiteSpace(Entry.Tags))
            {
                SelectedTags = Entry.Tags
                    .Split(',', StringSplitOptions.RemoveEmptyEntries)
                    .Select(t => t.Trim())
                    .Where(t => t.Length > 0)
                    .ToHashSet(StringComparer.OrdinalIgnoreCase);
            }
        }
        else
        {
            Entry.EntryDate = targetDate;
        }
    }

    private void TogglePreview()
    {
        IsPreview = !IsPreview;

        if (IsPreview)
        {
            var pipeline = new MarkdownPipelineBuilder()
                .UseAdvancedExtensions()
                .Build();

            RenderedHtml = Markdown.ToHtml(Entry.Content ?? "", pipeline);
        }
    }

    // === NEW: selection-based formatting via JS ===
    private async Task WrapSelection(string left, string right)
    {
        var newValue = await JS.InvokeAsync<string?>("journalEditor.wrapSelection", EditorTextAreaId, left, right);
        if (newValue is not null)
            Entry.Content = newValue;
    }

    private async Task InsertLine(string text)
    {
        var newValue = await JS.InvokeAsync<string?>("journalEditor.insertLine", EditorTextAreaId, text);
        if (newValue is not null)
            Entry.Content = newValue;
    }

    private async Task InsertLink()
    {
        // Put a link template around selection if selected, else inserts template.
        await WrapSelection("[", "](https://example.com)");
    }

    private void ToggleTag(string tag)
    {
        if (!SelectedTags.Add(tag))
            SelectedTags.Remove(tag);
    }

    private void AddCustomTag()
    {
        if (string.IsNullOrWhiteSpace(CustomTag)) return;
        SelectedTags.Add(CustomTag.Trim());
        CustomTag = string.Empty;
    }

    private async Task SaveEntry()
    {
        if (string.IsNullOrWhiteSpace(Entry.Title))
        {
            MessageClass = "alert-danger";
            Message = "Title is required.";
            return;
        }

        if (string.IsNullOrWhiteSpace(Entry.Content))
        {
            MessageClass = "alert-danger";
            Message = "Content cannot be empty.";
            return;
        }

        if (string.IsNullOrWhiteSpace(Entry.PrimaryMood))
        {
            MessageClass = "alert-danger";
            Message = "Primary mood is required.";
            return;
        }

        var p = Entry.PrimaryMood?.Trim();
        var s1 = string.IsNullOrWhiteSpace(Entry.SecondaryMood1) ? null : Entry.SecondaryMood1.Trim();
        var s2 = string.IsNullOrWhiteSpace(Entry.SecondaryMood2) ? null : Entry.SecondaryMood2.Trim();

        if (s1 != null && string.Equals(s1, p, StringComparison.OrdinalIgnoreCase))
        {
            MessageClass = "alert-danger";
            Message = "Secondary Mood 1 cannot be the same as Primary Mood.";
            return;
        }

        if (s2 != null && string.Equals(s2, p, StringComparison.OrdinalIgnoreCase))
        {
            MessageClass = "alert-danger";
            Message = "Secondary Mood 2 cannot be the same as Primary Mood.";
            return;
        }

        if (s1 != null && s2 != null && string.Equals(s1, s2, StringComparison.OrdinalIgnoreCase))
        {
            MessageClass = "alert-danger";
            Message = "Secondary Mood 1 and Secondary Mood 2 cannot be the same.";
            return;
        }

        Entry.Tags = string.Join(", ", SelectedTags);

        await JournalService.SaveAsync(Entry);

        MessageClass = "alert-success";
        Message = "Journal entry saved successfully.";
    }

    private async Task DeleteEntry()
    {
        await JournalService.DeleteAsync(Entry.EntryDate);

        Entry = new JournalEntry
        {
            EntryDate = DateOnly.FromDateTime(DateTime.Now)
        };

        SelectedTags.Clear();
        CustomTag = string.Empty;

        MessageClass = "alert-success";
        Message = "Journal entry deleted.";
    }
}
