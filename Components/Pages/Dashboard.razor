@page "/dashboard"
@using JournalApp.Models
@inject JournalApp.Services.JournalService JournalService

<h3>Dashboard</h3>

@if (IsLoading)
{
    <p>Loading...</p>
}
else
{
    <div style="display:flex; flex-wrap:wrap; gap:14px; margin-bottom:18px">
        <div class="cardbox">
            <div class="cardtitle">Total Entries</div>
            <div class="cardvalue">@TotalEntries</div>
        </div>

        <div class="cardbox">
            <div class="cardtitle">Current Streak</div>
            <div class="cardvalue">@CurrentStreak days</div>
        </div>

        <div class="cardbox">
            <div class="cardtitle">Longest Streak</div>
            <div class="cardvalue">@LongestStreak days</div>
        </div>

        <div class="cardbox">
            <div class="cardtitle">Missed Days (Last 30)</div>
            <div class="cardvalue">@MissedDaysCount</div>
        </div>
    </div>

    <div style="display:flex; flex-wrap:wrap; gap:18px; align-items:flex-start">

        <div style="flex:1; min-width:340px; max-width:520px">
            <h5>Mood Distribution</h5>

            @if (MoodStats.Count == 0)
            {
                <p>No mood data yet</p>
            }
            else
            {
                @foreach (var m in MoodStats)
                {
                    <div style="margin-bottom:10px">
                        <div style="display:flex; justify-content:space-between; font-size:14px">
                            <span>@m.Mood</span>
                            <span>@m.Count (@m.Percent%)</span>
                        </div>

                        <div style="height:12px; border-radius:999px; border:1px solid rgba(255,255,255,0.10); background:rgba(255,255,255,0.04); overflow:hidden">
                            <div style="height:100%; width:@(m.Percent)%; background:rgba(122, 92, 255, 0.75)"></div>
                        </div>
                    </div>
                }

                <div style="margin-top:8px">
                    <b>Most Frequent Mood:</b>
                    @(string.IsNullOrWhiteSpace(MostFrequentMood) ? "No data yet" : MostFrequentMood)
                </div>
            }
        </div>

        <div style="flex:1; min-width:340px; max-width:520px">
            <h5>Most Used Tags</h5>

            @if (TopTags.Count == 0)
            {
                <p>No tags yet</p>
            }
            else
            {
                @foreach (var t in TopTags)
                {
                    <div style="margin-bottom:10px">
                        <div style="display:flex; justify-content:space-between; font-size:14px">
                            <span>@t.Tag</span>
                            <span>@t.Count</span>
                        </div>

                        <div style="height:12px; border-radius:999px; border:1px solid rgba(255,255,255,0.10); background:rgba(255,255,255,0.04); overflow:hidden">
                            <div style="height:100%; width:@(t.Percent)%; background:rgba(255, 255, 255, 0.35)"></div>
                        </div>
                    </div>
                }
            }
        </div>

    </div>

    <div style="margin-top:22px; max-width:900px">
        <h5>Word Count Trend (Last 7 Days)</h5>

        @if (WordTrend.Count == 0)
        {
            <p>No entries in the last 7 days</p>
        }
        else
        {
            <div style="margin-bottom:10px">
                <b>Average words:</b> @AvgWordsLast7
            </div>

            @foreach (var w in WordTrend.OrderBy(x => x.Date))
            {
                <div style="margin-bottom:10px">
                    <div style="display:flex; justify-content:space-between; font-size:14px">
                        <span>@w.Date.ToString("yyyy-MM-dd")</span>
                        <span>@w.Words words</span>
                    </div>

                    <div style="height:12px; border-radius:999px; border:1px solid rgba(255,255,255,0.10); background:rgba(255,255,255,0.04); overflow:hidden">
                        <div style="height:100%; width:@(w.Percent)%; background:rgba(122, 92, 255, 0.45)"></div>
                    </div>
                </div>
            }
        }
    </div>
}

@code {
    private bool IsLoading = true;

    private int TotalEntries;
    private int CurrentStreak;
    private int LongestStreak;
    private int MissedDaysCount;

    private string MostFrequentMood = "";
    private int AvgWordsLast7;

    private List<MoodStat> MoodStats = new();
    private List<TagStat> TopTags = new();
    private List<WordStat> WordTrend = new();

    protected override async Task OnInitializedAsync()
    {
        IsLoading = true;

        var all = await JournalService.GetAllAsync();
        TotalEntries = all.Count;

        CalculateStreaks(all);
        CalculateMissedDaysLast30(all);

        CalculateMoodDistribution(all);
        CalculateTopTags(all);
        await CalculateWordTrendLast7();

        IsLoading = false;
    }

    private void CalculateStreaks(List<JournalEntry> all)
    {
        if (all.Count == 0)
        {
            CurrentStreak = 0;
            LongestStreak = 0;
            return;
        }

        var dates = all.Select(e => e.EntryDate)
                       .Distinct()
                       .OrderBy(d => d)
                       .ToList();

        int best = 1;
        int run = 1;

        for (int i = 1; i < dates.Count; i++)
        {
            if (dates[i] == dates[i - 1].AddDays(1))
                run++;
            else
                run = 1;

            if (run > best) best = run;
        }

        LongestStreak = best;

        var today = DateOnly.FromDateTime(DateTime.Today);
        int current = 0;

        var set = dates.ToHashSet();
        while (set.Contains(today.AddDays(-current)))
            current++;

        CurrentStreak = current;
    }

    private void CalculateMissedDaysLast30(List<JournalEntry> all)
    {
        var end = DateOnly.FromDateTime(DateTime.Today);
        var start = end.AddDays(-29);

        var dateSet = all.Select(e => e.EntryDate).ToHashSet();

        int missed = 0;
        for (int i = 0; i < 30; i++)
        {
            var d = start.AddDays(i);
            if (!dateSet.Contains(d))
                missed++;
        }

        MissedDaysCount = missed;
    }

    private void CalculateMoodDistribution(List<JournalEntry> all)
    {
        var groups = all
            .Where(e => !string.IsNullOrWhiteSpace(e.PrimaryMood))
            .GroupBy(e => e.PrimaryMood.Trim())
            .Select(g => new { Mood = g.Key, Count = g.Count() })
            .OrderByDescending(x => x.Count)
            .ToList();

        if (groups.Count == 0)
        {
            MoodStats = new();
            MostFrequentMood = "";
            return;
        }

        int total = groups.Sum(x => x.Count);

        MoodStats = groups
            .Select(x => new MoodStat
            {
                Mood = x.Mood,
                Count = x.Count,
                Percent = total == 0 ? 0 : (int)Math.Round((x.Count * 100.0) / total)
            })
            .ToList();

        MostFrequentMood = groups.First().Mood;
    }

    private void CalculateTopTags(List<JournalEntry> all)
    {
        var dict = new Dictionary<string, int>(StringComparer.OrdinalIgnoreCase);

        foreach (var e in all)
        {
            if (string.IsNullOrWhiteSpace(e.Tags)) continue;

            var tags = e.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries)
                             .Select(t => t.Trim())
                             .Where(t => t.Length > 0);

            foreach (var tag in tags)
            {
                if (!dict.ContainsKey(tag)) dict[tag] = 0;
                dict[tag]++;
            }
        }

        var list = dict
            .OrderByDescending(kv => kv.Value)
            .Take(8)
            .Select(kv => new TagStat { Tag = kv.Key, Count = kv.Value })
            .ToList();

        int max = list.Count == 0 ? 0 : list.Max(x => x.Count);

        foreach (var t in list)
            t.Percent = max == 0 ? 0 : (int)Math.Round((t.Count * 100.0) / max);

        TopTags = list;
    }

    private async Task CalculateWordTrendLast7()
    {
        var end = DateOnly.FromDateTime(DateTime.Today);
        var start = end.AddDays(-6);

        var range = await JournalService.GetRangeAsync(start, end);

        if (range.Count == 0)
        {
            AvgWordsLast7 = 0;
            WordTrend = new();
            return;
        }

        var byDay = range
            .GroupBy(e => e.EntryDate)
            .Select(g => new WordStat
            {
                Date = g.Key,
                Words = CountWords(g.First().Content)
            })
            .ToList();

        int totalWords = byDay.Sum(x => x.Words);
        AvgWordsLast7 = totalWords / byDay.Count;

        int max = byDay.Max(x => x.Words);
        foreach (var w in byDay)
            w.Percent = max == 0 ? 0 : (int)Math.Round((w.Words * 100.0) / max);

        WordTrend = byDay;
    }

    private int CountWords(string? text)
    {
        if (string.IsNullOrWhiteSpace(text)) return 0;

        return text.Split(new char[] { ' ', '\n', '\r', '\t' },
                          StringSplitOptions.RemoveEmptyEntries).Length;
    }

    private class MoodStat
    {
        public string Mood { get; set; } = "";
        public int Count { get; set; }
        public int Percent { get; set; }
    }

    private class TagStat
    {
        public string Tag { get; set; } = "";
        public int Count { get; set; }
        public int Percent { get; set; }
    }

    private class WordStat
    {
        public DateOnly Date { get; set; }
        public int Words { get; set; }
        public int Percent { get; set; }
    }
}
