@page "/dashboard"
@using JournalApp.Models
@inject JournalApp.Services.JournalService JournalService
@inject IJSRuntime JS

<h3>Dashboard</h3>

@if (IsLoading)
{
    <p>Loading...</p>
}
else
{
    <div style="display:flex; flex-wrap:wrap; gap:14px; margin-bottom:18px">
        <div class="cardbox">
            <div class="cardtitle">Total Entries</div>
            <div class="cardvalue">@TotalEntries</div>
        </div>

        <div class="cardbox">
            <div class="cardtitle">Current Streak</div>
            <div class="cardvalue">@CurrentStreak days</div>
        </div>

        <div class="cardbox">
            <div class="cardtitle">Longest Streak</div>
            <div class="cardvalue">@LongestStreak days</div>
        </div>

        <div class="cardbox">
            <div class="cardtitle">Missed Days (Last 30)</div>
            <div class="cardvalue">@MissedDaysCount</div>
        </div>
    </div>

    <div style="max-width:1000px; display:grid; grid-template-columns: 1fr 1fr; gap:18px;">
        <div class="cardbox" style="width:auto; padding:16px;">
            <h5>Mood Distribution (Primary Mood)</h5>
            <canvas id="moodPie"></canvas>
        </div>

        <div class="cardbox" style="width:auto; padding:16px;">
            <h5>Most Used Tags</h5>
            <canvas id="tagsBar"></canvas>
        </div>

        <div class="cardbox" style="grid-column: 1 / -1; width:auto; padding:16px;">
            <h5>Word Count Trend (Last 7 Days)</h5>
            <canvas id="wordTrend"></canvas>
        </div>
    </div>

    <div style="max-width:900px; margin-top:18px">
        <h5>Most Frequent Mood</h5>
        <p>@(string.IsNullOrWhiteSpace(MostFrequentMood) ? "No data yet" : MostFrequentMood)</p>

        <h5>Top Tags (Text)</h5>
        @if (TopTags.Count == 0)
        {
            <p>No tags yet</p>
        }
        else
        {
            <ul>
                @foreach (var t in TopTags)
                {
                    <li>@t.Tag (@t.Count)</li>
                }
            </ul>
        }

        <h5>Average Words (Last 7 Days)</h5>
        <p>@AvgWordsLast7</p>
    </div>
}

@code {
    private bool IsLoading = true;

    private int TotalEntries;
    private int CurrentStreak;
    private int LongestStreak;
    private int MissedDaysCount;

    private string MostFrequentMood = "";
    private int AvgWordsLast7;

    private List<TagCount> TopTags = new();

    // Chart data
    private List<MoodBucket> MoodBuckets = new();
    private List<WordPoint> WordTrend = new();

    private bool _chartsRendered = false;

    // Mood categories (simple + viva-friendly)
    private readonly HashSet<string> PositiveMoods = new(StringComparer.OrdinalIgnoreCase)
    { "Happy", "Excited", "Relaxed", "Grateful", "Confident" };

    private readonly HashSet<string> NeutralMoods = new(StringComparer.OrdinalIgnoreCase)
    { "Calm", "Thoughtful", "Curious", "Nostalgic", "Bored", "Okay", "Focused" };

    private readonly HashSet<string> NegativeMoods = new(StringComparer.OrdinalIgnoreCase)
    { "Sad", "Angry", "Stressed", "Lonely", "Anxious" };

    protected override async Task OnInitializedAsync()
    {
        IsLoading = true;

        var all = await JournalService.GetAllAsync();
        TotalEntries = all.Count;

        CalculateStreaks(all);
        CalculateMissedDaysLast30(all);
        CalculateMostFrequentMood(all);
        CalculateTopTags(all);
        await CalculateAvgWordsAndWordTrendLast7();
        CalculateMoodDistributionBuckets(all);

        IsLoading = false;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (IsLoading) return;

        // Render charts once AFTER the canvases exist in the UI
        if (!_chartsRendered)
        {
            _chartsRendered = true;
            await RenderCharts();
        }
    }

    private async Task RenderCharts()
    {
        // 1) Mood bucket pie
        var moodLabels = MoodBuckets.Select(x => x.Name).ToArray();
        var moodValues = MoodBuckets.Select(x => x.Count).ToArray();
        await JS.InvokeVoidAsync("journalCharts.renderMoodPie", "moodPie", moodLabels, moodValues);

        // 2) Tags bar
        var tagLabels = TopTags.Select(x => x.Tag).ToArray();
        var tagValues = TopTags.Select(x => x.Count).ToArray();
        await JS.InvokeVoidAsync("journalCharts.renderTagsBar", "tagsBar", tagLabels, tagValues);

        // 3) Word trend
        var wordLabels = WordTrend.Select(x => x.Label).ToArray();
        var wordValues = WordTrend.Select(x => x.Words).ToArray();
        await JS.InvokeVoidAsync("journalCharts.renderWordTrend", "wordTrend", wordLabels, wordValues);
    }

    private void CalculateStreaks(List<JournalEntry> all)
    {
        if (all.Count == 0)
        {
            CurrentStreak = 0;
            LongestStreak = 0;
            return;
        }

        var dates = all.Select(e => e.EntryDate)
                       .Distinct()
                       .OrderBy(d => d)
                       .ToList();

        int best = 1;
        int run = 1;

        for (int i = 1; i < dates.Count; i++)
        {
            if (dates[i] == dates[i - 1].AddDays(1))
                run++;
            else
                run = 1;

            if (run > best) best = run;
        }

        LongestStreak = best;

        var today = DateOnly.FromDateTime(DateTime.Today);
        int current = 0;

        while (dates.Contains(today.AddDays(-current)))
        {
            current++;
        }

        CurrentStreak = current;
    }

    private void CalculateMissedDaysLast30(List<JournalEntry> all)
    {
        var end = DateOnly.FromDateTime(DateTime.Today);
        var start = end.AddDays(-29);

        var dateSet = all.Select(e => e.EntryDate).ToHashSet();

        int missed = 0;
        for (int i = 0; i < 30; i++)
        {
            var d = start.AddDays(i);
            if (!dateSet.Contains(d))
                missed++;
        }

        MissedDaysCount = missed;
    }

    private void CalculateMostFrequentMood(List<JournalEntry> all)
    {
        MostFrequentMood = all
            .Where(e => !string.IsNullOrWhiteSpace(e.PrimaryMood))
            .GroupBy(e => e.PrimaryMood.Trim())
            .OrderByDescending(g => g.Count())
            .Select(g => g.Key)
            .FirstOrDefault() ?? "";
    }

    private void CalculateTopTags(List<JournalEntry> all)
    {
        var dict = new Dictionary<string, int>(StringComparer.OrdinalIgnoreCase);

        foreach (var e in all)
        {
            if (string.IsNullOrWhiteSpace(e.Tags)) continue;

            var tags = e.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries)
                             .Select(t => t.Trim())
                             .Where(t => t.Length > 0);

            foreach (var tag in tags)
            {
                if (!dict.ContainsKey(tag)) dict[tag] = 0;
                dict[tag]++;
            }
        }

        TopTags = dict
            .OrderByDescending(kv => kv.Value)
            .Take(8)
            .Select(kv => new TagCount { Tag = kv.Key, Count = kv.Value })
            .ToList();
    }

    private async Task CalculateAvgWordsAndWordTrendLast7()
    {
        var end = DateOnly.FromDateTime(DateTime.Today);
        var start = end.AddDays(-6);

        var range = await JournalService.GetRangeAsync(start, end);

        if (range.Count == 0)
        {
            AvgWordsLast7 = 0;
            WordTrend = BuildEmptyWeekTrend(start);
            return;
        }

        // Build per-day word counts (even for days with no entries -> 0)
        var map = range.ToDictionary(x => x.EntryDate, x => CountWords(x.Content));

        WordTrend = new List<WordPoint>();
        int totalWords = 0;
        int daysWithEntries = 0;

        for (int i = 0; i < 7; i++)
        {
            var d = start.AddDays(i);
            map.TryGetValue(d, out int words);

            WordTrend.Add(new WordPoint
            {
                Label = d.ToString("MM-dd"),
                Words = words
            });

            if (words > 0)
            {
                totalWords += words;
                daysWithEntries++;
            }
        }

        AvgWordsLast7 = daysWithEntries == 0 ? 0 : totalWords / daysWithEntries;
    }

    private List<WordPoint> BuildEmptyWeekTrend(DateOnly start)
    {
        var list = new List<WordPoint>();
        for (int i = 0; i < 7; i++)
        {
            var d = start.AddDays(i);
            list.Add(new WordPoint { Label = d.ToString("MM-dd"), Words = 0 });
        }
        return list;
    }

    private void CalculateMoodDistributionBuckets(List<JournalEntry> all)
    {
        int pos = 0, neu = 0, neg = 0;

        foreach (var e in all)
        {
            var mood = e.PrimaryMood?.Trim();
            if (string.IsNullOrWhiteSpace(mood)) continue;

            if (PositiveMoods.Contains(mood)) pos++;
            else if (NegativeMoods.Contains(mood)) neg++;
            else neu++; // anything else goes to neutral
        }

        MoodBuckets = new List<MoodBucket>
        {
            new MoodBucket { Name = "Positive", Count = pos },
            new MoodBucket { Name = "Neutral", Count = neu },
            new MoodBucket { Name = "Negative", Count = neg }
        };
    }

    private int CountWords(string? text)
    {
        if (string.IsNullOrWhiteSpace(text)) return 0;

        return text.Split(new char[] { ' ', '\n', '\r', '\t' },
                          StringSplitOptions.RemoveEmptyEntries).Length;
    }

    private class TagCount
    {
        public string Tag { get; set; } = "";
        public int Count { get; set; }
    }

    private class MoodBucket
    {
        public string Name { get; set; } = "";
        public int Count { get; set; }
    }

    private class WordPoint
    {
        public string Label { get; set; } = "";
        public int Words { get; set; }
    }
}
