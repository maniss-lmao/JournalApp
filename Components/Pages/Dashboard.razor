@page "/dashboard"
@using JournalApp.Models
@inject JournalApp.Services.JournalService JournalService

<h3>Dashboard</h3>

@if (IsLoading)
{
    <p>Loading...</p>
}
else
{
    <div style="display:flex; flex-wrap:wrap; gap:14px; margin-bottom:18px">
        <div class="cardbox">
            <div class="cardtitle">Total Entries</div>
            <div class="cardvalue">@TotalEntries</div>
        </div>

        <div class="cardbox">
            <div class="cardtitle">Current Streak</div>
            <div class="cardvalue">@CurrentStreak days</div>
        </div>

        <div class="cardbox">
            <div class="cardtitle">Longest Streak</div>
            <div class="cardvalue">@LongestStreak days</div>
        </div>

        <div class="cardbox">
            <div class="cardtitle">Missed Days (Last 30)</div>
            <div class="cardvalue">@MissedDaysCount</div>
        </div>
    </div>

    <div style="max-width:900px">
        <h5>Most Frequent Mood</h5>
        <p>@(string.IsNullOrWhiteSpace(MostFrequentMood) ? "No data yet" : MostFrequentMood)</p>

        <h5>Most Used Tags</h5>
        @if (TopTags.Count == 0)
        {
            <p>No tags yet</p>
        }
        else
        {
            <ul>
                @foreach (var t in TopTags)
                {
                    <li>@t.Tag (@t.Count)</li>
                }
            </ul>
        }

        <h5>Word Count (Last 7 Days)</h5>
        <p>Average: @AvgWordsLast7</p>
    </div>
}

@code {
    private bool IsLoading = true;

    private int TotalEntries;
    private int CurrentStreak;
    private int LongestStreak;
    private int MissedDaysCount;

    private string MostFrequentMood = "";
    private int AvgWordsLast7;

    private List<TagCount> TopTags = new();

    protected override async Task OnInitializedAsync()
    {
        IsLoading = true;

        var all = await JournalService.GetAllAsync();
        TotalEntries = all.Count;

        CalculateStreaks(all);
        CalculateMissedDaysLast30(all);
        CalculateMostFrequentMood(all);
        CalculateTopTags(all);
        await CalculateAvgWordsLast7();

        IsLoading = false;
    }

    private void CalculateStreaks(List<JournalEntry> all)
    {
        if (all.Count == 0)
        {
            CurrentStreak = 0;
            LongestStreak = 0;
            return;
        }

        var dates = all.Select(e => e.EntryDate)
                       .Distinct()
                       .OrderBy(d => d)
                       .ToList();

        // Longest streak
        int best = 1;
        int run = 1;

        for (int i = 1; i < dates.Count; i++)
        {
            if (dates[i] == dates[i - 1].AddDays(1))
                run++;
            else
                run = 1;

            if (run > best) best = run;
        }

        LongestStreak = best;

        // Current streak (count back from today)
        var today = DateOnly.FromDateTime(DateTime.Today);
        int current = 0;

        while (dates.Contains(today.AddDays(-current)))
        {
            current++;
        }

        CurrentStreak = current;
    }

    private void CalculateMissedDaysLast30(List<JournalEntry> all)
    {
        var end = DateOnly.FromDateTime(DateTime.Today);
        var start = end.AddDays(-29);

        var dateSet = all.Select(e => e.EntryDate).ToHashSet();

        int missed = 0;
        for (int i = 0; i < 30; i++)
        {
            var d = start.AddDays(i);
            if (!dateSet.Contains(d))
                missed++;
        }

        MissedDaysCount = missed;
    }

    private void CalculateMostFrequentMood(List<JournalEntry> all)
    {
        MostFrequentMood = all
            .Where(e => !string.IsNullOrWhiteSpace(e.PrimaryMood))
            .GroupBy(e => e.PrimaryMood.Trim())
            .OrderByDescending(g => g.Count())
            .Select(g => g.Key)
            .FirstOrDefault() ?? "";
    }

    private void CalculateTopTags(List<JournalEntry> all)
    {
        var dict = new Dictionary<string, int>(StringComparer.OrdinalIgnoreCase);

        foreach (var e in all)
        {
            if (string.IsNullOrWhiteSpace(e.Tags)) continue;

            var tags = e.Tags.Split(',', StringSplitOptions.RemoveEmptyEntries)
                             .Select(t => t.Trim())
                             .Where(t => t.Length > 0);

            foreach (var tag in tags)
            {
                if (!dict.ContainsKey(tag)) dict[tag] = 0;
                dict[tag]++;
            }
        }

        TopTags = dict
            .OrderByDescending(kv => kv.Value)
            .Take(8)
            .Select(kv => new TagCount { Tag = kv.Key, Count = kv.Value })
            .ToList();
    }

    private async Task CalculateAvgWordsLast7()
    {
        var end = DateOnly.FromDateTime(DateTime.Today);
        var start = end.AddDays(-6);

        var range = await JournalService.GetRangeAsync(start, end);

        if (range.Count == 0)
        {
            AvgWordsLast7 = 0;
            return;
        }

        int totalWords = 0;
        foreach (var e in range)
        {
            var words = CountWords(e.Content);
            totalWords += words;
        }

        AvgWordsLast7 = totalWords / range.Count;
    }

    private int CountWords(string? text)
    {
        if (string.IsNullOrWhiteSpace(text)) return 0;

        return text.Split(new char[] { ' ', '\n', '\r', '\t' },
                          StringSplitOptions.RemoveEmptyEntries).Length;
    }

    private class TagCount
    {
        public string Tag { get; set; } = "";
        public int Count { get; set; }
    }
}
