@page "/export"
@inject JournalApp.Services.JournalService JournalService

@using QuestPDF.Fluent
@using QuestPDF.Helpers
@using QuestPDF.Infrastructure
@using JournalApp.Models

<h3>Export Journals (PDF)</h3>

<div style="max-width:500px">

    <label>From Date</label>
    <input type="date" class="form-control" @bind="FromDate" />

    <br />

    <label>To Date</label>
    <input type="date" class="form-control" @bind="ToDate" />

    <br />

    <button class="btn btn-primary" @onclick="ExportPdf">
        Export PDF
    </button>

    @if (!string.IsNullOrWhiteSpace(Message))
    {
        <div class="alert alert-success" style="margin-top:12px">
            @Message
        </div>
    }
</div>

@code {
    private DateTime FromDate = DateTime.Today.AddDays(-7);
    private DateTime ToDate = DateTime.Today;

    private string? Message;

    private async Task ExportPdf()
    {
        var from = DateOnly.FromDateTime(FromDate);
        var to = DateOnly.FromDateTime(ToDate);

        var entries = await JournalService.GetRangeAsync(from, to);

        if (entries.Count == 0)
        {
            Message = "No entries found in selected range.";
            return;
        }

        var filePath = Path.Combine(
            FileSystem.AppDataDirectory,
            $"Journal_{from}_{to}.pdf"
        );

        Document.Create(container =>
        {
            container.Page(page =>
            {
                page.Size(PageSizes.A4);
                page.Margin(30);
                page.DefaultTextStyle(x => x.FontSize(12));

                page.Content().Column(col =>
                {
                    col.Item().Text("Journal Export")
                        .FontSize(20)
                        .Bold()
                        .AlignCenter();

                    col.Item().PaddingVertical(10);

                    foreach (var e in entries)
                    {
                        col.Item().Border(1).Padding(10).Column(c =>
                        {
                            c.Item().Text($"{e.EntryDate:yyyy-MM-dd} - {e.Title}")
                                .Bold();

                            c.Item().Text($"Mood: {e.PrimaryMood}");

                            if (!string.IsNullOrWhiteSpace(e.Tags))
                                c.Item().Text($"Tags: {e.Tags}");

                            c.Item().PaddingTop(6);
                            c.Item().Text(e.Content);
                        });

                        col.Item().PaddingVertical(6);
                    }
                });
            });
        })
        .GeneratePdf(filePath);

        Message = $"PDF exported successfully to:\n{filePath}";
    }
}
