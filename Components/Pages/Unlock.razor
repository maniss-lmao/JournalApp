@page "/unlock"
@inject JournalApp.Services.LockService LockService
@inject JournalApp.Services.AppState AppState
@inject NavigationManager Nav

<h3>Unlock Journal</h3>

@if (!string.IsNullOrEmpty(Message))
{
    <div class="alert @MessageClass" style="max-width:450px">@Message</div>
}

<div style="max-width:450px">
    @if (!string.IsNullOrWhiteSpace(Username))
    {
        <p>Welcome, <b>@Username</b></p> @* Personalised unlock screen *@
    }

    <label>Enter PIN / Password</label>
    <input class="form-control" type="password" @bind="Pin" />

    <br />

    <button class="btn btn-primary" @onclick="Unlock_user">
        Unlock
    </button>

    <button class="btn btn-danger" style="margin-left:10px" @onclick="GoToResetVerify">
        Reset (Forgot PIN)
    </button>

    <button class="btn btn-secondary" @onclick="ResetAccount">
        Reset Account
    </button>
</div>

@code {
    private string Username = "";
    private string Pin = "";
    private string? Message;
    private string MessageClass = "alert-danger";

    protected override async Task OnInitializedAsync()
    {
        // Redirects to setup if no lock is configured
        if (!await LockService.HasPinAsync())
        {
            Nav.NavigateTo("/setup", true);
            return;
        }

        Username = LockService.GetUsername(); // Retrieved for display only
    }

    private async Task Unlock_user()
    {
        Message = null;

        if (string.IsNullOrWhiteSpace(Pin))
        {
            MessageClass = "alert-danger";
            Message = "PIN is required.";
            return;
        }

        var ok = await LockService.VerifyPinAsync(Pin); // Secure verification
        if (!ok)
        {
            MessageClass = "alert-danger";
            Message = "Incorrect PIN. Try again.";
            return;
        }

        AppState.SetUnlocked(string.IsNullOrWhiteSpace(Username) ? "User" : Username); // Session unlock
        Nav.NavigateTo("/editor", true);
    }

    private async Task ResetAll()
    {
        await LockService.ResetAccountAsync(); // Full reset including PIN
        AppState.Lock();
        Nav.NavigateTo("/setup", true);
    }

    private void GoToResetVerify()
    {
        Nav.NavigateTo("/reset-verify", true); // Security question flow
    }

    private async Task ResetAccount()
    {
        await LockService.ResetAccountAsync(); // Hard reset without verification
        Nav.NavigateTo("/setup", true);
    }
}
